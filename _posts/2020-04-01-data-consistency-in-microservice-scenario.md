---
author: baixiaoustc
comments: true
date: 2020-04-01 12:12:46+00:00
layout: post
slug: 2020-04-01-data-consistency-in-microservice-scenario
title: 数据一致性之二：微服务场景下的数据一致性
categories:
- 后端技术
tags:
- 分布式 
- 微服务
---

* content 
{:toc}

前文简述了「领域内的数据一致性」，本文来说一说「领域间的数据一致性」。在业务实践中，特别是在微服务场景下，针对不同场景对一致性不同的要求程度，阐述不同的业务模型。

# 微服务之间的数据同步模型

下面从**一致性逐渐增强**的角度，阐述了各种同步模型。当然这只是一个大概的评价，像同步和异步的模式有些情况无法对比。

## 同步请求

业务场景：最普通的微服务之间的请求模型，常用 RPC 实现（含 http 协议）。上游依赖下游的信息（但不是最核心的信息），不处理失败场景。

### 模型分析

针对 RPC 的特性，有三种可能

* 请求成功，正常返回（包括业务正确或错误）
* 发起请求阶段网络异常，下游未处理
* 返回请求阶段网络异常，下游已处理
* 有点类似 Unix I/O 模型中的阻塞 I/O

简单处理失败场景的话，如下加入重试。

## 同步请求+重试

业务场景：同步请求失败的情况下（含网络错误或超时），假设是网络抖动引起的，延迟一小段时间后重试。

### 模型分析

* 重试后依然失败的可以报警人工处理
* 重试次数有限制，重试间隔可以用指数递增
* 多数是读请求，如果是写请求的话需要下游保证幂等性

下图是同步请求及重试的示意图：

![](http://image99.renyit.com/文章画图.004.png)

## 同步请求+轮询

业务场景：针对整体延迟较高的业务场景，上游服务依赖的下游服务处理时间较长，上游服务执意在「同一个会话」中等待同步数据流程完成。比如某些业务需要等待确认支付流程成功，必须在当前会话中轮询。


### 模型分析

* 下游服务需要在接收到请求时做持久化，提高可靠性
* 轮询间隔时间可以由下游服务指定
* 有点类似 Unix I/O 模型中的非阻塞I/O


## 同步请求+回执

业务场景：和上述的回执模型类似，下游服务处理时间较长，不同的是下游处理完毕后主动通知上游。

### 模型分析

* 一般不是用户侧发起的路径
* 也是最终一致性的体现
* 有点类似 Unix I/O 模型中的信号驱动I/O

下图是同步请求+轮询及回执的示意图：

![](http://image99.renyit.com/文章画图.005.png)

## 异步队列

业务场景：消息异步处理模式多应用于非核心链路上负载较高的处理环节中，井且服务的上游不关心下游的处理结果，下游也不需要向上游返回处理结果。

### 模型分析

* 我们工程实践中使用 kafka 作为消息队列
* 实践中 Producer 选择折中的 ack 策略（仅 leader 确认），平衡高并发和高可用
* 实践中 Consumer 选择 oldest 的接入策略和手动 commit 的确认方式，避免服务中途重启可能导致的消息丢失
* kafkka 的订阅模式，即同一个 topic 对应多消费者组的模式，很适合单上游多下游的服务模式

## 异步队列+落表

业务场景：在异步的场景下，为了更高程度的保证可靠性，在服务的上游（生产者这端）加强通知的有效性，即如果消息队列暂时不响应的话，需要对消息落表保存，待后续异步重试。

### 模型分析

* 首先对投递方进行失败重试
* 若干次失败后写数据库，等待异步执行的 worker 扫描数据库后重试
* 我们在实践中也遇到过数次 kafka 集群异常重启，整个阶段可能持续数分钟

下图是异步队列及落表的示意图：

![](http://image99.renyit.com/文章画图.006.png)

*对照我们的 mns 系统。*

## 同步请求+异步队列，请求重放系统

## 异步最大化

# 同步和异步的对比

同步调用在任何软件系统中都是不可避免的，但是我们软件工程师必须明白同步调用给软件系统带来的问题。如果我们将应用程序串接起来，那么系统的可用性就会低于任何一个单一组件的可用性。比如组件A同步调用了组件B，组件A的可用性为99.9%，组件B的可用性为99.9%,那么组件A同步调用组件B的可用性就是99.9% * 99.9%=99.8%。同步调用使得系统的可用性受到了所有串接组件可用性的影响，因此我们在系统设计的时候应该清楚哪些地方应该同步调用，在不需要同步调用的时候尽量的进行异步的调用

xxxxxx

# 为什么补偿型不行？

# 参考

* [分布式事务一致性解决方案](https://www.cnblogs.com/williamjie/p/11200885.html)
* [微服务下的数据一致性的几种实现方式之概述](https://www.jianshu.com/p/b264a196b177)
* [伸缩性和可用性反模式](https://www.jdon.com/37794)