---
author: baixiaoustc
comments: true
date: 2020-03-27 12:12:46+00:00
layout: post
slug: 2020-03-27-how-to-understand-data-consistency
title: 怎么理解数据一致性
categories:
- 后端技术
tags:
- 分布式 
- 微服务
---

* content 
{:toc}

# 两种数据一致性？

之前一致性这个概念听得多了，有时候指系统内各节点保持一致，有时候又指不同系统的协同合作一致。到底含义如何，困扰了我相当长的时间。现在我将其定义为两个概念：

## 领域内的数据一致性

一般我们读到的文章谈到说「**分布式一致性**」都是指这个概念，大名鼎鼎的 Paxos 协议、Raft 协议等都是在研究这个，也称为共识算法。更基础一点的模型是 2PC、3PC、TCC模型等等。这是一个很大的命题，也相当复杂，但是可以简化为`寄存器模型`：

	SET x = 1
	GET x
	EXPECT x == 1
	
就这么简单！不管这个`寄存器`背后有多少个节点、集群、leader、follower，它对外就是一个「存东西的地方」。想想我们业务中使用的 etcd 是不是就干这个事情的。

## 领域间的数据一致性

我们现在后端架构基本都是微服务实现。尽管微服务带来了迭代效率、资源隔离等好处，但是也带来了很多新的技术问题。之前通过关系型数据库的单体事务保证的一致性，现在在不同系统的不同数据库存储，无法通过老办法保证一致。

实际上这是「**分布式事务**」在研究的事情。也有一种说法是将其定义为「业务一致性」。

# 几种容易混淆的一致性定义

好几个理论或者模型中都提到了一致性 Consistency，到底作何区别？

## 关系型数据库事务 ACID 中的 Consistency

数据库的事务机制是通过 ACID 实现的，复习一下 ACID 的定义：

* Atomic 原子性: 一个事务的所有系列操作步骤被看成是一个动作，所有的步骤要么全部完成要么一个也不会完成，如果事务过程中任何一点失败，将要被改变的数据库记录就不会被真正被改变。
* Consistency 一致性: 在事务开始或结束时，数据库应该在一致状态。也就是说，通过各种途径包括外键约束等任何写入数据库的数据都是有效的，不能发生表与表之间存在外键约束，但是有数据却违背这种约束性。所有改变数据库数据的动作事务必须完成，没有事务会创建一个无效数据状态.
* Isolated 隔离性: 主要用于实现并发控制, 隔离能够确保并发执行的事务能够顺序一个接一个执行，通过隔离，一个未完成事务不会影响另外一个未完成事务。
* Durable 持久性: 一旦一个事务被提交，它应该持久保存，不会因为和其他操作冲突而取消这个事务。很多人认为这意味着事务是持久在磁盘上，但是规范没有特别定义这点。

这里的一致性是为了保证系统数据的`保护性`和`不变性`，不论在何种并发的情况下。以转账案例为例，假设有五个账户，每个账户余额是100元，那么五个账户总额是500元，如果在这个5个账户之间同时发生多个转账，无论并发多少个，比如在A与B账户之间转账5元，在C与D账户之间转账10元，在B与E之间转账15元，五个账户总额也应该还是500元，这就是`保护性`和`不变性`。

## CAP 理论中的 Consistency

复习下 CAP 理论的定义：

* Consistency 一致性
* Availability 可用性
* Partition tolerance 分区容错性

CAP 理论认为，一个分布式系统中的 CAP三种属性，只能同时满足其中两种。

CAP 理论中的 Consistency 是分布式领域下的一致性表述，和上面 ACID 的一致性完全是不同领域的概念。为了保证领域中不同节点的数据是`相同的`，或者说服务器之间数据复制整齐一致了。还是以银行账户举例，我在支付宝存了100万☺️，那么支付宝杭州机房里面的数据存储我的账户为100万，支付宝在北京的机房也必须是100万！这是 CAP 理论的 Consistency 保证的。

![](http://image99.renyit.com/2020-03-27-1.jpeg)

<center>图自《这可能是我看过最通俗也是最深刻的CAP理论》</center>

## BASE 理论中的 Eventual consistency

所谓柔性事务为了满足可用性、性能与降级服务的需要，降低一致性与隔离性的要求，遵循 BASE 理论：

* Basic Availability 基本业务可用性，接受响应时间变慢或者非关键模块宕机等意外情况。
* Soft state 柔性状态，也叫软状态，指的是允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性。
* Eventual consistency 最终一致性，如字面含义。

BASE 理论 是对 CAP 的妥协。对于普遍的互联网场景而言，保证可用性的要求要高于一致性，故一致性的约束降级为最终一致性。考虑到用户体验，这个最终一致的时间窗口，要尽可能的对用户透明。

和 ACID 相对比，BASE 理论面向的是大型高可用可扩展的分布式系统，通过牺牲强一致性来获得可用性。这两种模型分别是向一致性和可用性这两个维度的靠拢。有趣的是，ACID 和 BASE 恰巧分别在化学里面是酸和碱的含义。

# 分布式系统的一致性的不同层级

我们来看一下一致性的不同程度的约束。

## 弱一致性

和强一致性相对，系统并不保证连续进程或者线程的访问都会返回最新的更新过的值。系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到。但会尽可能保证在某个时间级别（比如秒级别）之后，可以让数据达到一致性状态。最终一致性是弱一致性的特定形式。

## 强一致性

强一致性也就是指一旦有写操作写入任何一个服务器，立即在其他服务器之间同步复制新的数据，这样任何服务器上任何读操作总是能看到最近写入的新数据。

## 线性一致性

比强一致性更强的一种约束称为线性一致性（linearizable consistency）。线性化的意思是，一旦写完成，其后的所有其他读操作应该返回写入的值或者最近写入的值，一旦读返回一个特定的值，所有其后读取应该返回的也是这个值或最近写入的值。另一种描述是：

> 如果 B 操作在成功完成 A 操作之后，那么整个系统对 B 操作来说必须表现为 A 操作已经完成了或者更新的状态。

让我们来看一个例子。在这个例子中的系统并不是可线性化的。

![](http://image99.renyit.com/2020-03-27-2.png)

<center>图自《这可能是我看过最通俗也是最深刻的CAP理论》</center>

	这张图展示了 Alice 还有 Bob, 他们在同一个房间，都在用他们的手机查询 2014 年世界杯的决赛结果。
	
	就在最终结果刚发布之后，Alice 刷新了页面，看到了宣布冠军的消息，而且很兴奋地告诉了 Bob。
	
	Bob 马上也重新加载了他手机上的页面，但是他的请求被送到了一个数据库的拷贝，还没有拿到最新的数据，结果他的手机上显示决赛还正在进行。
	
	如果 Alice 和 Bob 同时刷新，拿到了不一样的结果，并不会太让人意外。因为他们不知道具体服务器到底是先处理了他们中哪一个请求。
	
	但是 Bob 知道他刷新页面是在 Alice 告诉了他最终结果之后的。所以他预期他查询的结果一定比 Alice 的更新。事实是，他却拿到了旧的结果。这就违反了可线性化。

最后说一句，CAP 理论中要求的一致性正是线性一致性。


# 参考

* [ACID中C与CAP定理中C的区别](https://www.jdon.com/46956)
* [这可能是我看过最通俗也是最深刻的CAP理论](https://mp.weixin.qq.com/s/6PgqyigrgVICl0JiI73oNg)
* [分布式理论之BASE理论](https://segmentfault.com/a/1190000018019595)